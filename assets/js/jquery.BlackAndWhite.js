(function(e){e.fn.extend({BlackAndWhite:function(t){"use strict";var n=this,r={hoverEffect:true,webworkerPath:false,responsive:true,invertHoverEffect:false,speed:500,onImageReady:null,intensity:1};t=e.extend(r,t);var i=t.hoverEffect,s=t.webworkerPath,o=t.invertHoverEffect,u=t.responsive,a=typeof t.intensity==="number"&&t.intensity<1&&t.intensity>0?t.intensity:1,f=e.isPlainObject(t.speed)?t.speed.fadeIn:t.speed,l=e.isPlainObject(t.speed)?t.speed.fadeOut:t.speed;var c=document.all&&!window.opera&&window.XMLHttpRequest?true:false;var h=" -webkit- -moz- -o- -ms- ".split(" ");var p={};var d=function(e){if(p[e]||p[e]==="")return p[e]+e;var t=document.createElement("div");var n=["","Moz","Webkit","O","ms","Khtml"];for(var r in n){if(typeof t.style[n[r]+e]!=="undefined"){p[e]=n[r];return n[r]+e}}return e.toLowerCase()};var v=function(){var e=document.createElement("div");e.style.cssText=h.join("filter"+":blur(2px); ");return!!e.style.length&&(document.documentMode===undefined||document.documentMode>9)}();var m=!!document.createElement("canvas").getContext,g=e(window),y=function(){return typeof Worker!=="undefined"?true:false}(),b=d("Filter"),w=[],E=y&&s?new Worker(s+"BnWWorker.js"):false;var S=function(t){e(t.currentTarget).find(".BWfade").stop(true,true)[!o?"fadeIn":"fadeOut"](l)};var x=function(t){e(t.currentTarget).find(".BWfade").stop(true,true)[o?"fadeIn":"fadeOut"](f)};var T=function(e){if(typeof t.onImageReady==="function")t.onImageReady(e)};var N=function(){if(!w.length){if(E.terminate)E.terminate();if(E.close)E.close();return}E.postMessage({imgData:w[0].imageData,intensity:a});E.onmessage=function(e){w[0].ctx.putImageData(e.data,0,0);T(w[0].img);w.splice(0,1);N()}};var C=function(e,t,n,r){var i=t.getContext("2d"),s=e,o=0,u;i.drawImage(e,0,0,n,r);var f=i.getImageData(0,0,n,r),l=f.data,c=l.length;if(E){w.push({imageData:f,ctx:i,img:e})}else{for(;o<c;o+=4){var h=l[o]*.3+l[o+1]*.59+l[o+2]*.11;l[o]=~~(h*a+l[o]*(1-a));l[o+1]=~~(h*a+l[o+1]*(1-a));l[o+2]=~~(h*a+l[o+2]*(1-a))}i.putImageData(f,0,0);T(e)}};var k=function(t,n){var r=t[0],i=r.src,s=t.width(),u=t.height(),f=t.position(),l={position:"absolute",top:f.top,left:f.left,display:o?"none":"block"},c;if(m&&!v){var h=r.width,p=r.height;c=e('<canvas class="BWfade" width="'+h+'" height="'+p+'"></canvas>');c.css(l);c.prependTo(n);C(r,c.get(0),h,p)}else{l[d("Filter")]="grayscale("+a*100+"%)";c=e("<img src="+i+' width="'+s+'" height="'+u+'" class="BWFilter BWfade" /> ');c.css(e.extend(l,{filter:"progid:DXImageTransform.Microsoft.BasicImage(grayscale=1)"}));c.prependTo(n);T(r)}};this.init=function(t){n.each(function(t,n){var r=e(n),i=r.find("img");if(!i.width())i.on("load",function(){k(i,r)});else k(i,r)});if(E){N()}if(i){n.on("mouseleave",S);n.on("mouseenter",x)}if(u){g.on("resize orientationchange",n.resizeImages)}};this.resizeImages=function(){n.each(function(t,n){var r=e(n).find("img:not(.BWFilter)"),i=c?e(r).prop("width"):e(r).width(),s=c?e(r).prop("height"):e(r).height();e(this).find(".BWFilter, canvas").css({width:i,height:s})})};return this.init(t)}})})(jQuery)